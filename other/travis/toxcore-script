#!/bin/sh

# Enable test coverage recording.
export CFLAGS="$CFLAGS -fprofile-arcs -ftest-coverage"

# Build toxcore and run tests.
# TODO(iphydf): Enable ASAN. It currently has some bad interactions with gcov,
# so it's disabled on Travis.
RUN $CMAKE -B$BUILD_DIR -H. -DCMAKE_INSTALL_PREFIX:PATH=$CURDIR/_install -DDEBUG=ON -DASSOC_DHT=ON -DSTRICT_ABI=ON #-DASAN=ON

RUN make -C $BUILD_DIR -j$NPROC -k install

if $TESTS; then
  export CTEST_OUTPUT_ON_FAILURE=1
  RUN make -C $BUILD_DIR -j$NPROC test
fi
